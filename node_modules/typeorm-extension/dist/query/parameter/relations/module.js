"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.applyRelations = exports.applyQueryRelations = exports.applyQueryRelationsParseOutput = void 0;
const rapiq_1 = require("rapiq");
const utils_1 = require("../../utils");
/**
 * Apply parsed include/relation parameter data on the db query.
 *
 * @param query
 * @param data
 * @param options
 */
function applyQueryRelationsParseOutput(query, data, options) {
    options = options || {};
    for (let i = 0; i < data.length; i++) {
        const parts = data[i].key.split('.');
        let key;
        if (parts.length > 1) {
            key = parts.slice(-2).join('.');
        }
        else {
            key = (0, utils_1.buildKeyWithPrefix)(data[i].key, options.defaultAlias);
        }
        data[i].key = key;
        /* istanbul ignore next */
        query.leftJoinAndSelect(key, data[i].value);
    }
    return data;
}
exports.applyQueryRelationsParseOutput = applyQueryRelationsParseOutput;
/**
 * Apply raw include/relations parameter data on the db query.
 *
 * @param query
 * @param data
 * @param options
 */
function applyQueryRelations(query, data, options) {
    return applyQueryRelationsParseOutput(query, (0, rapiq_1.parseQueryRelations)(data, options), options);
}
exports.applyQueryRelations = applyQueryRelations;
/**
 * Apply raw include/relations parameter data on the db query.
 *
 * @param query
 * @param data
 * @param options
 */
function applyRelations(query, data, options) {
    return applyQueryRelations(query, data, options);
}
exports.applyRelations = applyRelations;
